<template>
  <div class="calendar w-full mx-auto">
    <div class="flex items-center justify-left mx-auto p-2 border-0 rounded shadow-none">
      <Button @click="prevMonth" class="">
        <FontAwesomeIcon :icon="['fas', 'angle-left']" class="m font-light" />
      </Button>

      <div class="flex flex-col items-center justify-center min-w-[16ch] font-bold ml-2 mr-2">
        <span @click="toggleMonthPanel" class="px-2 py-1 cursor-pointer hover:bg-gray-200 rounded">
          {{ currentMonthName }}
        </span>
        <span @click="toggleYearPanel" class="px-2 py-1 cursor-pointer hover:bg-gray-200 rounded">
          {{ currentYear }}
        </span>
      </div>

      <Button @click="nextMonth">
        <FontAwesomeIcon :icon="['fas', 'angle-right']" class="m font-light" />
      </Button>
      <label for="toggle-all" class="mr-2 ml-2">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</label>
      <ToggleSwitch v-model="toggleAll" inputId="toggle-all" />

      <Popover ref="monthPanel" :pt="{ root: { class: 'z-50' } }">
        <div class="grid grid-cols-3 gap-1">
          <template v-for="(m, i) in MONTHS.accusativeFirstUpper" :key="i">
            <button
              @click="selectMonth(i)"
              class="py-1 px-3 rounded hover:bg-blue-100"
              :class="{ 'bg-emerald-500 text-white': i === currentMonthNumber }"
            >
              {{ m }}
            </button>
          </template>
        </div>
      </Popover>

      <Popover ref="yearPanel" :pt="{ root: { class: 'z-50' } }">
        <div class="grid grid-cols-2 gap-1">
          <template v-for="y in YEARS" :key="y">
            <button
              @click="selectYear(y)"
              class="py-1 px-3 rounded hover:bg-blue-100"
              :class="{ 'bg-emerald-500 text-white': y === currentYear }"
            >
              {{ y }}
            </button>
          </template>
        </div>
      </Popover>
    </div>
    <Accordion multiple class="mt-2">
      <AccordionPanel v-for="week in calendarData" :value="week.weekNumber" :key="week.weekNumber">
        <AccordionHeader
          >{{ week.weekNumber }} –Ω–µ–¥–µ–ª—è | c {{ week.days[0].titleDate }} –ø–æ
          {{ week.days[6].titleDate }}</AccordionHeader
        >
        <AccordionContent>
          <div class="grid grid-cols-7 gap-2" mt-2>
            <div v-for="day in week.days" :key="day.date">
              <div
                class="w-full flex flex-col items-center justify-center font-bold rounded-xl"
                :style="{
                  background: day.dayIndex > 4 ? '#ef4444' : '#22d3ee',
                }"
              >
                <span>{{ day.dayName }}</span>
                <span>{{ day.titleDate }}</span>
              </div>
              <div class="flex flex-col justify-center mt-2 gap-2">
                <ItemPost
                  v-for="event in eventsByDate[day.date]"
                  :key="event.id"
                  :region="event.region"
                  :text="event.text"
                  :performer="event.performer"
                />
                <Button class="mx-auto max-w-fit" :key="day.date" @click="() => addEvent(day.currentDate)">
                  <FontAwesomeIcon :icon="['fas', 'plus']" />
                </Button>                
              </div>
            </div>
          </div>
        </AccordionContent>
      </AccordionPanel>
    </Accordion>
    <Dialog
                  v-model:visible="visible"
                  modal
                  closeOnEscape
                  header="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ"
                  :pt="{
      headerActions: {
        style: { display: 'none' }
      }
    }"
                >
                <div>
                  <DatePicker  v-model="selectedDate" dateFormat="dd.mm.yy" :showIcon="true" class="w-full"/>
                </div>
                  <div class="flex items-center gap-4 mb-4">
                    <label for="username" class="font-semibold w-24">Username</label>
                    <InputText id="username" class="flex-auto" autocomplete="off" />
                  </div>
                  <div class="flex items-center gap-4 mb-8">
                    <label for="email" class="font-semibold w-24">Email</label>
                    <InputText id="email" class="flex-auto" autocomplete="off" />
                  </div>
                  <div class="flex justify-end gap-2">
                    <Button
                      type="button"
                      label="Cancel"
                      severity="secondary"
                      @click="visible = false"
                    ></Button>
                    <Button type="button" label="Save" @click="visible = false"></Button>
                  </div>
                </Dialog>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { MONTHS } from '@/constants/date'

const currentDate = ref(new Date())
const currentMonthNumber = ref(currentDate.value.getMonth())
const currentYear = ref(currentDate.value.getFullYear())
const calendarData = ref(null)
const monthPanel = ref()
const yearPanel = ref()

const visible = ref(false)
const selectedDate = ref(null)

function addEvent(date) {
  visible.value = true;
  selectedDate.value = date;
}

const toggleAll = ref(false)

function getMonday(date) {
  const d = new Date(date)
  const day = d.getDay()
  const diff = d.getDate() - day + (day === 0 ? -6 : 1)
  return new Date(d.setDate(diff))
}

const dayNames = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞']

const YEARS = ['2020', '2021', '2022', '2023', '2024', '2025', '2026', '2027', '2028']
const eventsByDate = computed(() => {
  const map = {}
  eventsData.value.forEach((event) => {
    const date = event.date
    if (!map[date]) map[date] = []
    map[date].push(event)
  })
  return map
})

const eventsData = ref([
  // üìÖ –ò—é–Ω—å 2025
  {
    id: 1,
    region: '–ú–æ—Å–∫–≤–∞',
    text: '–ö–æ–Ω—Ü–µ—Ä—Ç –≥—Ä—É–ø–ø—ã "–õ—é–±—ç"',
    performer: '–õ—é–±—ç',
    date: '2025-06-30',
  },

  // üìÖ –ò—é–ª—å 2025
  {
    id: 2,
    region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
    text: '–í—ã—Å—Ç–∞–≤–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞',
    performer: '–ì–∞–ª–µ—Ä–µ—è "–ê—Ä—Ç-–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ"',
    date: '2025-07-03',
  },
  {
    id: 3,
    region: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
    text: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è',
    performer: 'IT Experts Group',
    date: '2025-07-05',
  },
  {
    id: 4,
    region: '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
    text: '–ù–∞—É—á–Ω—ã–π —Å–∏–º–ø–æ–∑–∏—É–º',
    performer: '–°–∏–±–∏—Ä—Å–∫–∞—è –∞–∫–∞–¥–µ–º–∏—è –Ω–∞—É–∫',
    date: '2025-07-06',
  },
  {
    id: 5,
    region: '–ö–∞–∑–∞–Ω—å',
    text: '–§–µ—Å—Ç–∏–≤–∞–ª—å —Ç–∞—Ç–∞—Ä—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã',
    performer: '–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—É–ª—å—Ç—É—Ä–Ω—ã–π —Ü–µ–Ω—Ç—Ä',
    date: '2025-07-08',
  },
  {
    id: 6,
    region: '–°–æ—á–∏',
    text: '–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—å ¬´Black Sea Fest¬ª',
    performer: 'DJ Max & Friends',
    date: '2025-07-10',
  },
  {
    id: 7,
    region: '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫',
    text: '–§—É–¥–º–∞—Ä–∫–µ—Ç —É –º–æ—Ä—è',
    performer: 'Local Street Food',
    date: '2025-07-12',
  },
  {
    id: 8,
    region: '–ú–æ—Å–∫–≤–∞',
    text: '–§–µ—Å—Ç–∏–≤–∞–ª—å —É–ª–∏—á–Ω–æ–π –µ–¥—ã',
    performer: 'Street Food Team',
    date: '2025-07-15',
  },
  {
    id: 9,
    region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
    text: '–î–∂–∞–∑–æ–≤—ã–π –≤–µ—á–µ—Ä –Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–æ–π',
    performer: 'Jazz Band',
    date: '2025-07-17',
  },
  {
    id: 10,
    region: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
    text: '–†–æ–∫-—Ñ–µ—Å—Ç–∏–≤–∞–ª—å',
    performer: 'Rock Legends',
    date: '2025-07-19',
  },
  {
    id: 11,
    region: '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
    text: '–ü—Ä–∞–∑–¥–Ω–∏–∫ –≥–æ—Ä–æ–¥–∞',
    performer: '–ì–æ—Ä–æ–¥—Å–∫–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è',
    date: '2025-07-20',
  },
  {
    id: 12,
    region: '–ö–∞–∑–∞–Ω—å',
    text: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è —è—Ä–º–∞—Ä–∫–∞ —Ä–µ–º—ë—Å–µ–ª',
    performer: '–ì–∏–ª—å–¥–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤',
    date: '2025-07-22',
  },
  {
    id: 13,
    region: '–°–æ—á–∏',
    text: '–§–µ—Å—Ç–∏–≤–∞–ª—å –∫–∏–Ω–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤',
    performer: '–ö–∏–Ω–æ—Å–æ—é–∑ –†–§',
    date: '2025-07-24',
  },
  {
    id: 14,
    region: '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫',
    text: '–§–µ—Å—Ç–∏–≤–∞–ª—å –∞–∑–∏–∞—Ç—Å–∫–æ–≥–æ –∫–∏–Ω–æ',
    performer: '–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω—ã–π –∫–∏–Ω–æ–∫–ª—É–±',
    date: '2025-07-27',
  },
  {
    id: 15,
    region: '–ú–æ—Å–∫–≤–∞',
    text: '–ö–æ–Ω—Ü–µ—Ä—Ç –º–æ–ª–æ–¥—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π',
    performer: 'PRIMORSK Music School',
    date: '2025-07-29',
  },
  {
    id: 16,
    region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
    text: '–¢–µ–∞—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ "–ì—Ä–æ–∑–∞"',
    performer: '–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π —Ç–µ–∞—Ç—Ä –¥—Ä–∞–º—ã',
    date: '2025-07-31',
  },

  // üìÖ –ê–≤–≥—É—Å—Ç 2025
  {
    id: 17,
    region: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
    text: '–í—ã—Å—Ç–∞–≤–∫–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –±—É–¥—É—â–µ–≥–æ',
    performer: 'Tech Future Lab',
    date: '2025-08-01',
  },
  {
    id: 18,
    region: '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
    text: '–ö–∏–Ω–æ –ø–æ–¥ –æ—Ç–∫—Ä—ã—Ç—ã–º –Ω–µ–±–æ–º',
    performer: '–ö–∏–Ω–æ–∫–ª—É–± "–°–≤–µ—Ç"',
    date: '2025-08-03',
  },
])

const toggleMonthPanel = (event) => {
  monthPanel.value.toggle(event)
}

function selectMonth(month) {
  currentMonthNumber.value = month
  monthStructureUpdate()
  monthPanel.value.hide()
}

const toggleYearPanel = (event) => {
  yearPanel.value.toggle(event)
}

function selectYear(year) {
  currentYear.value = year
  monthStructureUpdate()
  yearPanel.value.hide()
}

function getDayName(date) {
  return dayNames[date.getDay()]
}

function getMonthStructure(year, month) {
  const weeks = []
  let currentDate = getMonday(new Date(year, month, 1))

  do {
    const weekDays = []

    for (let i = 0; i < 7; i++) {
      const current = new Date(currentDate)

      weekDays.push({
        currentDate: current,
        date: formatDate(current),
        year: current.getFullYear(),
        month: current.getMonth(),
        day: current.getDate(),
        dayName: getDayName(current),
        dayIndex: i,
        titleDate: titleDate(current.getDate(), current.getMonth()),
        inCurrentMonth: current.getMonth() === month,
      })

      currentDate.setDate(currentDate.getDate() + 1)
    }

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
    const firstDayOfWeek = new Date(weekDays[0].year, weekDays[0].month, weekDays[0].day)
    const weekNumber = getISOWeekNumber(firstDayOfWeek) // ‚úÖ –ü–µ—Ä–µ–¥–∞—ë–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏

    weeks.push({
      weekNumber,
      year: weekDays[0].year,
      days: weekDays,
    })
  } while (
    currentDate.getMonth() === month || // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∫–∞ –º–µ—Å—è—Ü —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    currentDate.getDay() !== 1 // –∏–ª–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
  )

  return weeks
}

function formatDate(date) {
  const d = new Date(date)
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  return `${d.getFullYear()}-${month}-${day}`
}

function titleDate(day, month) {
  return `${day} ${MONTHS.genitive[month]}`
}

const currentMonthName = computed(() => {
  return MONTHS.accusativeFirstUpper[currentMonthNumber.value]
})

function getISOWeekNumber(date) {
  const d = new Date(date)
  d.setHours(0, 0, 0, 0)
  const dayOfWeek = d.getDay()
  const diff = d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1)
  const monday = new Date(d.setDate(diff))

  const yearStart = new Date(monday.getFullYear(), 0, 1)
  const yearStartMonday = new Date(yearStart)
  const startDay = yearStart.getDay()
  yearStartMonday.setDate(
    yearStart.getDate() + (startDay === 1 ? 0 : startDay > 1 ? 8 - startDay : 1)
  )

  const weekNumber =
    Math.round(((monday - yearStartMonday) / 86400000 + yearStartMonday.getDate() - 1) / 7) + 1
  return weekNumber
}

function nextMonth() {
  if (currentMonthNumber.value === 11) {
    currentMonthNumber.value = 0
    currentYear.value++
  } else {
    currentMonthNumber.value++
  }
  monthStructureUpdate()
}

function prevMonth() {
  if (currentMonthNumber.value === 0) {
    currentMonthNumber.value = 11
    currentYear.value--
  } else {
    currentMonthNumber.value--
  }
  monthStructureUpdate()
}

function monthStructureUpdate() {
  calendarData.value = getMonthStructure(currentYear.value, currentMonthNumber.value)
}

// —Ö—É–∫–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
onMounted(() => {
  monthStructureUpdate()
})
</script>
